# テスト計画書 (Test Plan)

本プロジェクトの安定稼働に向けた各種テスト項目の計画および実行プロトコルです。

## 1. 単体テスト項目 (Unit Tests)

主に `MainActivity.kt` 内部のデータ変換およびロジックのテストです。（JUnitを使用）

- [ ] **JSONパース処理**: `cleanJson()` に正常なマークダウン付JSON、不要なテキストが含まれたJSON、パース不可能な文字列を渡し、想定通りにサニタイズ・例外発生するか確認。
- [ ] **コマンドマッチング**: 終了コマンドリスト（"戻って", "go back" 等）の `ignoreCase` マッチングが、大文字小文字や空白を含んでも正しく検知されるか。
- [ ] **タイムアウト・ライフサイクル管理**: `postSafely()` により登録された `Runnable` が、`clearActionRunnables()` 呼出時に確実にリストから削除され、実行されないことのMockテスト。

## 2. 結合テスト項目 (Integration Tests : フロー)

UI要素の表示切り替え・状態フラグの検証です。

- [ ] **シナリオ通しテスト (Happy Path)**: `IDLE` → `GREETING` → `LISTENING` → API呼出 → `GUIDANCE` → `NAVIGATION` → `ARRIVAL` → `IDLE` への表示切り替え順序が完全に連続するか。
- [ ] **不在復帰テスト**: `IDLE` 画面状態で30秒間なにも操作しなかった場合、自動で `idleToHomeRunnable` が発火し、ホームベースへ移動するコマンドが発行されるか。
- [ ] **キャンセルテスト**: どの画面からでも `btnEndSession` またはそれと同等のボタンを押下した際、即座にタイマー処理が破棄(`clearActionRunnables`)され、IDLE状態にリセットされるか。
- [ ] **スタッフ呼び出し遷移**: インテントが `call_staff` と判定された場合、正しく `screen_staff.xml` が表示されプログレスバーのアニメーションが開始されるか。

## 3. SDK連携テスト項目 (Device / SDK Tests)

Temiハードウェアに依存する挙動のテストです。実機またはエミュレータ（SDKの仮想モード）が必須です。

- [ ] **goTo コマンド検証**: `locationInfo` に定義された場所を指定した際、エラーを吐かずに `robot.goTo` が発火するか（`noRotationAtEnd=true` の確認）。
- [ ] **状態遷移イベント (onGoToLocationStatusChanged)**:
  - `calculating`, `going` を経由して `complete` を受信した場合の `turnBy(180)` の発火確認。
  - 経路上に障害物を置いて、`abort` および `reposing` のステータスが発火し、例外処理ルーチン（ホーム帰還）へ安全に落ちるかの確認。
- [ ] **TtsRequest 検証**: `speak` に渡すリスエストにおいて、`isShowOnConversationLayer = false` が有効であり、システムデフォルトの顔UIが自作の画面を覆い隠さないことの確認。
- [ ] **人感センサー (DetectionState)**: 意図的に人（遮蔽物）をセンサーから遠ざけ、不在タイマー（15秒）が稼働して自律的に案内を中止する挙動の確認。

---

## 4. 実機テスト手順書 (Field Testing Protocol)

テスターが実際の店舗（検証環境）で歩行検証を行うための手順です。

1. **環境準備**: 店舗環境にて Temi に対象アプリのAPKをインストールし、`home base` と定義した地点および案内先の数地点（例: `メンズトップス`）をあらかじめ Temi のシステム機能を利用してマップに記憶させておく。
2. **起動確認**: アプリを起動し、フルスクリーン（Kioskモード）で猫コンシェルジュの待機画面が表示されることを確認。
3. **対話テスト**:
   - ロボットの前に立ち、挨拶が自動再生されるか確認。
   - 画面をタップ、または音声に反応してマイクが起動し、「Tシャツありますか？」と発声。
   - 文字起こし（ASR結果）が画面 (`tvLiveTranscription`) に正しく即座に反映されるか確認。
4. **追従走行テスト**:
   - 案内開始のアナウンス後、ナビゲーション画面(`screen_navigation`)が表示されロボットが移動し始めるか。
   - 移動完了後、到着地点で180度ターンを行い、到着画面(`screen_arrival`)が表示されるか確認。
5. **例外テスト（障害物）**:
   - 移動中にロボットのすぐ前に立ちふさがり、わざと進路をブロックする。数秒以内に「案内を中断しました」と諦めてホームへ帰る動作に移行することを検証する。

---

## テスト結果記録テンプレート

不具合を発見した場合は以下のフォーマットでチケットを切ってください。

```markdown
### 報告日: 
### テスタ名: 
### 発見箇所（画面・シナリオ）:
### トリガー（どのような操作を行ったか）:
### 期待した動作:
### 実際の動作（エラー内容）:
### ログ（Logcatまたは guide_log.csv の抜粋）:
```
