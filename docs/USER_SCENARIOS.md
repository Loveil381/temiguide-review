# ユーザーシナリオ集 (User Scenarios)

本ドキュメントでは、アプリが想定している主要な利用シナリオ（正常系・異常系）を定義します。テストや運用時の確認指標として利用してください。

## 🟢 正常系シナリオ (Happy Paths)

### 1. 単一の売り場案内（ダイレクト指定）
- **トリガー**: ユーザーが「メンズトップスはどこですか？」と尋ねる。
- **期待される動作**:
  1. AIが意図を解釈し、即座に `action: guide`, `location: メンズトップス` を返す。
  2. GUIDANCE画面が表示され、「メンズトップスですね。ご案内します。」と発話しながら移動を開始。
  3. 目的地到着後、ロボットが180度旋回し到着を通知する。
- **確認ポイント**: 正しい地点に向かっているか。到着後にユーザーの方を向くか。

### 2. アイテム名からの売り場推定
- **トリガー**: ユーザーが「HEATTECH（ヒートテック）が欲しい」と尋ねる。
- **期待される動作**:
  1. AIがヒートテック＝インナー類であると解釈する。
  2. `location: インナー` として案内アクションを実行。
  3. 「ヒートテックですね。インナー・肌着売り場にご案内します」と返答。
- **確認ポイント**: AI連携フローが働き、適切なカテゴリマッピングが行われるか。

### 3. コーディネート相談（非ナビゲーション）
- **トリガー**: ユーザーが「ダウンジャケットに合うパンツを教えて」と尋ねる。
- **期待される動作**:
  1. AIが質問(Question)と判断し `action: speak` を返す。
  2. 「ダウンにはすっきりとしたジーンズが合いますよ。ご案内しましょうか？」と口頭で返答。
  3. その後、自動でマイクが起動(`askQuestion`と同等)し、ユーザーの「はいお願い」という回答を待つ。
- **確認ポイント**: 画面が遷移せず LISTENING 状態のままであること。

### 4. 複数地点の提示（案内は1箇所のみ）
- **トリガー**: ユーザーが「レディースのトップスと、試着室に行きたい」と尋ねる。
- **期待される動作**:
  1. システムプロンプトのルールに基づき、最初の地点（レディーストップス）のみを `location` に設定し `action: guide` で応答。
  2. 発話内容は「まずレディーストップスへご案内し、その後試着室の場所をお伝えします」となる。
- **確認ポイント**: 無効な複数地點指定でエラーにならず、安全な1箇所ナビゲーションに帰着すること。

### 5. 人感センサーからの自発的アプローチ
- **トリガー**: IDLE画面表示中、ロボットの前を人が横切る。
- **期待される動作**:
  1. `onDetectionStateChanged` が反応。
  2. 即座に GREETING 画面へ遷移し、マイクが自動的にオンになる。
- **確認ポイント**: 画面タップなしでも案内が開始できること。

---

## 🛑 異常系シナリオ (Edge Cases & Fallbacks)

### 1. 音声認識 (ASR) が無音・認識失敗
- **トリガー**: LISTENING状態で、ユーザーが何も話さないか、極端なノイズ環境にいる。
- **期待される動作**:
  1. `asrResult` が空で返ってくる。
  2. `askQuestion("もう一度おっしゃっていただけますか？")` で再度リスニングを試みる。2回連続で空結果の場合は自動的にIDLE画面に戻る。
  3. タイムアウトルーチン(`ASR_TIMEOUT_MS` = 15秒)が発動し、強制的にキャンセルされる。
- **確認ポイント**: 無限にマイクが起動したままにならないこと。

### 2. AI API 通信エラー (ネットワーク異常)
- **トリガー**: APIリクエスト送出後にWi-Fiが切断される。
- **期待される動作**:
  1. Retrofitの `onFailure` コールバックがトリガー。
  2. `fallbackSpeak` が呼び出され、「申し訳ございません、もう一度お話しいただけますか？」と発話。
  3. 数秒後にIDLE画面へリセットされる。
- **確認ポイント**: アプリがクラッシュせず、初期状態へ優雅に後退(graceful degradation)できること。

### 3. ナビゲーションの強制中断 (Abort)
- **トリガー**: 案内中に人が進路を完全に塞ぐ、または非常停止ボタン（STOP）が押される。
- **期待される動作**:
  1. `onGoToLocationStatusChanged` で `abort` を受信。
  2. ロボットが「案内を中断しました。ホームに戻ります。」と発話し、ナビゲーションを終了。
  3. 遅延実行で自動的に `home base` への帰還アクションが発動する。
- **確認ポイント**: 中断状態のまま立ち往生せず、ホームポイントへ戻ろうとすること。

### 4. スタッフの不在・呼び出しタイムアウト
- **トリガー**: 「サイズが合いません（スタッフの介入が必要）」と発言する。
- **期待される動作**:
  1. AIが `action: call_staff` を選択し、STAFF_ASSIST 画面へ遷移。
  2. 30秒経過してもスタッフが来ない（画面上のキャンセル/完了ボタンが押されない）場合、タイムアウトが発生。
  3. 「スタッフが見つかりませんでした」と謝罪し、ホームへ帰還する。
- **確認ポイント**: 呼び出し画面のままいつまでも待機し続けないこと。

### 5. 案内中にお客さんが離脱した
- **トリガー**: 目的地へ移動中に、ユーザーが別の方向へ行ってしまい、センサーから人が消える。
- **期待される動作**:
  1. `onDetectionStateChanged` にて不在を検知。
  2. 15秒間のタイマーが発動し、「お客様？」と呼びかける。
  3. それでも人が戻らない場合、案内モードを強制キャンセルしてホームへ戻る。
- **確認ポイント**: ロボット単独で目的地へ移動・放置されることを防げているか。
